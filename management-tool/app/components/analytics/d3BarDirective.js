AnalyticsManagementVisualizationApp.directive('d3Bars', ['d3Service', '$window', function (d3Service, $window) {
	return {
		restrict: 'EA',
		scope: {
			barRequest: "="
		},
		link: function (scope, ele, attrs) {
			var window = $window;
			d3Service.d3().then(function (d3) {

				//scope.barRequest = {"data":{"start_date":"2014-08-31T22:00:00.000Z","end_date":"2014-09-29T22:00:00.000Z","view_id":"554cf494cd19d72339000017","columnHeaders":[{"name":"count","columnType":"METRIC"},{"name":"dateHour","columnType":"DIMENSION","dataType":"DATE"},{"name":"allVisitors","columnType":"DIMENSION","dataType":"INTEGER"}],"rows":[["2014-09-02T11:00+00:00",3],["2014-09-02T12:00+00:00",26],["2014-09-02T13:00+00:00",34],["2014-09-02T14:00+00:00",29],["2014-09-02T15:00+00:00",35],["2014-09-02T16:00+00:00",17],["2014-09-02T17:00+00:00",10],["2014-09-02T19:00+00:00",1],["2014-09-02T20:00+00:00",1],["2014-09-02T21:00+00:00",1],["2014-09-03T04:00+00:00",1],["2014-09-03T05:00+00:00",1],["2014-09-03T06:00+00:00",9],["2014-09-03T07:00+00:00",26],["2014-09-03T08:00+00:00",30],["2014-09-03T09:00+00:00",27],["2014-09-03T10:00+00:00",33],["2014-09-03T11:00+00:00",24],["2014-09-03T12:00+00:00",23],["2014-09-03T13:00+00:00",34],["2014-09-03T14:00+00:00",38],["2014-09-03T15:00+00:00",30],["2014-09-03T16:00+00:00",22],["2014-09-03T17:00+00:00",9],["2014-09-03T19:00+00:00",1],["2014-09-03T20:00+00:00",1],["2014-09-03T23:00+00:00",1],["2014-09-04T02:00+00:00",1],["2014-09-04T05:00+00:00",1],["2014-09-04T06:00+00:00",16],["2014-09-04T07:00+00:00",35],["2014-09-04T08:00+00:00",45],["2014-09-04T09:00+00:00",41],["2014-09-04T10:00+00:00",43],["2014-09-04T11:00+00:00",37],["2014-09-04T12:00+00:00",42],["2014-09-04T13:00+00:00",47],["2014-09-04T14:00+00:00",44],["2014-09-04T15:00+00:00",45],["2014-09-04T16:00+00:00",29],["2014-09-04T17:00+00:00",16],["2014-09-04T18:00+00:00",1],["2014-09-04T21:00+00:00",1],["2014-09-04T22:00+00:00",1],["2014-09-05T02:00+00:00",1],["2014-09-05T06:00+00:00",29],["2014-09-05T07:00+00:00",39],["2014-09-05T08:00+00:00",52],["2014-09-05T09:00+00:00",47],["2014-09-05T10:00+00:00",38],["2014-09-05T11:00+00:00",52],["2014-09-05T12:00+00:00",51],["2014-09-05T13:00+00:00",46],["2014-09-05T14:00+00:00",52],["2014-09-05T15:00+00:00",51],["2014-09-05T16:00+00:00",41],["2014-09-05T17:00+00:00",29],["2014-09-06T01:00+00:00",1],["2014-09-06T06:00+00:00",47],["2014-09-06T07:00+00:00",48],["2014-09-06T08:00+00:00",63],["2014-09-06T09:00+00:00",65],["2014-09-06T10:00+00:00",58],["2014-09-06T11:00+00:00",58],["2014-09-06T12:00+00:00",42],["2014-09-06T13:00+00:00",46],["2014-09-06T14:00+00:00",59],["2014-09-06T15:00+00:00",53],["2014-09-06T16:00+00:00",42],["2014-09-06T17:00+00:00",29],["2014-09-06T18:00+00:00",1],["2014-09-06T23:00+00:00",1],["2014-09-08T05:00+00:00",2],["2014-09-08T06:00+00:00",11],["2014-09-08T07:00+00:00",28],["2014-09-08T08:00+00:00",32],["2014-09-08T09:00+00:00",30],["2014-09-08T10:00+00:00",21],["2014-09-08T11:00+00:00",22],["2014-09-08T12:00+00:00",19],["2014-09-08T13:00+00:00",23],["2014-09-08T14:00+00:00",22],["2014-09-08T15:00+00:00",27],["2014-09-08T16:00+00:00",26],["2014-09-08T17:00+00:00",10],["2014-09-08T21:00+00:00",1],["2014-09-09T01:00+00:00",1],["2014-09-09T02:00+00:00",2],["2014-09-09T03:00+00:00",1],["2014-09-09T06:00+00:00",16],["2014-09-09T07:00+00:00",28],["2014-09-09T08:00+00:00",29],["2014-09-09T09:00+00:00",21],["2014-09-09T10:00+00:00",23],["2014-09-09T11:00+00:00",21],["2014-09-09T12:00+00:00",19],["2014-09-09T13:00+00:00",18],["2014-09-09T14:00+00:00",22],["2014-09-09T15:00+00:00",19],["2014-09-09T16:00+00:00",14],["2014-09-09T17:00+00:00",12],["2014-09-09T22:00+00:00",1],["2014-09-10T02:00+00:00",1],["2014-09-10T06:00+00:00",12],["2014-09-10T07:00+00:00",23],["2014-09-10T08:00+00:00",29],["2014-09-10T09:00+00:00",27],["2014-09-10T10:00+00:00",18],["2014-09-10T11:00+00:00",20],["2014-09-10T12:00+00:00",21],["2014-09-10T13:00+00:00",22],["2014-09-10T14:00+00:00",28],["2014-09-10T15:00+00:00",19],["2014-09-10T16:00+00:00",23],["2014-09-10T17:00+00:00",12],["2014-09-11T02:00+00:00",2],["2014-09-11T03:00+00:00",1],["2014-09-11T05:00+00:00",1],["2014-09-11T06:00+00:00",14],["2014-09-11T07:00+00:00",23],["2014-09-11T08:00+00:00",38],["2014-09-11T09:00+00:00",32],["2014-09-11T10:00+00:00",29],["2014-09-11T11:00+00:00",27],["2014-09-11T12:00+00:00",27],["2014-09-11T13:00+00:00",33],["2014-09-11T14:00+00:00",35],["2014-09-11T15:00+00:00",29],["2014-09-11T16:00+00:00",27],["2014-09-11T17:00+00:00",13],["2014-09-11T18:00+00:00",1],["2014-09-11T19:00+00:00",1],["2014-09-11T20:00+00:00",1],["2014-09-11T21:00+00:00",1],["2014-09-11T22:00+00:00",1],["2014-09-12T02:00+00:00",1],["2014-09-12T03:00+00:00",2],["2014-09-12T04:00+00:00",1],["2014-09-12T06:00+00:00",33],["2014-09-12T07:00+00:00",48],["2014-09-12T08:00+00:00",35],["2014-09-12T09:00+00:00",40],["2014-09-12T10:00+00:00",38],["2014-09-12T11:00+00:00",39],["2014-09-12T12:00+00:00",41],["2014-09-12T13:00+00:00",51],["2014-09-12T14:00+00:00",51],["2014-09-12T15:00+00:00",44],["2014-09-12T16:00+00:00",34],["2014-09-12T17:00+00:00",20],["2014-09-12T18:00+00:00",1],["2014-09-13T01:00+00:00",1],["2014-09-13T02:00+00:00",1],["2014-09-13T06:00+00:00",38],["2014-09-13T07:00+00:00",45],["2014-09-13T08:00+00:00",59],["2014-09-13T09:00+00:00",68],["2014-09-13T10:00+00:00",57],["2014-09-13T11:00+00:00",45],["2014-09-13T12:00+00:00",52],["2014-09-13T13:00+00:00",50],["2014-09-13T14:00+00:00",51],["2014-09-13T15:00+00:00",49],["2014-09-13T16:00+00:00",46],["2014-09-13T17:00+00:00",21],["2014-09-13T19:00+00:00",1],["2014-09-15T03:00+00:00",1],["2014-09-15T04:00+00:00",1],["2014-09-15T05:00+00:00",1],["2014-09-15T06:00+00:00",15],["2014-09-15T07:00+00:00",23],["2014-09-15T08:00+00:00",29],["2014-09-15T09:00+00:00",31],["2014-09-15T10:00+00:00",29],["2014-09-15T11:00+00:00",19],["2014-09-15T12:00+00:00",15],["2014-09-15T13:00+00:00",28],["2014-09-15T14:00+00:00",27],["2014-09-15T15:00+00:00",31],["2014-09-15T16:00+00:00",22],["2014-09-15T17:00+00:00",14],["2014-09-15T19:00+00:00",1],["2014-09-15T20:00+00:00",3],["2014-09-16T06:00+00:00",12],["2014-09-16T07:00+00:00",21],["2014-09-16T08:00+00:00",30],["2014-09-16T09:00+00:00",33],["2014-09-16T10:00+00:00",33],["2014-09-16T11:00+00:00",18],["2014-09-16T12:00+00:00",26],["2014-09-16T13:00+00:00",28],["2014-09-16T14:00+00:00",27],["2014-09-16T15:00+00:00",23],["2014-09-16T16:00+00:00",21],["2014-09-16T17:00+00:00",10],["2014-09-16T21:00+00:00",1],["2014-09-17T04:00+00:00",1],["2014-09-17T05:00+00:00",1],["2014-09-17T06:00+00:00",13],["2014-09-17T07:00+00:00",27],["2014-09-17T08:00+00:00",30],["2014-09-17T09:00+00:00",33],["2014-09-17T10:00+00:00",29],["2014-09-17T11:00+00:00",29],["2014-09-17T12:00+00:00",24],["2014-09-17T13:00+00:00",29],["2014-09-17T14:00+00:00",27],["2014-09-17T15:00+00:00",28],["2014-09-17T16:00+00:00",24],["2014-09-17T17:00+00:00",10],["2014-09-17T19:00+00:00",1],["2014-09-17T20:00+00:00",1],["2014-09-18T04:00+00:00",1],["2014-09-18T06:00+00:00",19],["2014-09-18T07:00+00:00",29],["2014-09-18T08:00+00:00",37],["2014-09-18T09:00+00:00",36],["2014-09-18T10:00+00:00",30],["2014-09-18T11:00+00:00",28],["2014-09-18T12:00+00:00",30],["2014-09-18T13:00+00:00",34],["2014-09-18T14:00+00:00",38],["2014-09-18T15:00+00:00",35],["2014-09-18T16:00+00:00",27],["2014-09-18T17:00+00:00",10],["2014-09-18T19:00+00:00",1],["2014-09-18T20:00+00:00",2],["2014-09-18T21:00+00:00",3],["2014-09-19T06:00+00:00",26],["2014-09-19T07:00+00:00",38],["2014-09-19T08:00+00:00",43],["2014-09-19T09:00+00:00",37],["2014-09-19T10:00+00:00",33],["2014-09-19T11:00+00:00",41],["2014-09-19T12:00+00:00",40],["2014-09-19T13:00+00:00",42],["2014-09-19T14:00+00:00",51],["2014-09-19T15:00+00:00",43],["2014-09-19T16:00+00:00",45],["2014-09-19T17:00+00:00",18],["2014-09-19T18:00+00:00",1],["2014-09-20T06:00+00:00",39],["2014-09-20T07:00+00:00",33],["2014-09-20T08:00+00:00",51],["2014-09-20T09:00+00:00",54],["2014-09-20T10:00+00:00",50],["2014-09-20T11:00+00:00",48],["2014-09-20T12:00+00:00",42],["2014-09-20T13:00+00:00",53],["2014-09-20T14:00+00:00",39],["2014-09-20T15:00+00:00",44],["2014-09-20T16:00+00:00",37],["2014-09-20T17:00+00:00",19],["2014-09-20T18:00+00:00",1],["2014-09-20T20:00+00:00",1],["2014-09-22T06:00+00:00",15],["2014-09-22T07:00+00:00",15],["2014-09-22T08:00+00:00",32],["2014-09-22T09:00+00:00",25],["2014-09-22T10:00+00:00",23],["2014-09-22T11:00+00:00",17],["2014-09-22T12:00+00:00",22],["2014-09-22T13:00+00:00",25],["2014-09-22T14:00+00:00",21],["2014-09-22T15:00+00:00",19],["2014-09-22T16:00+00:00",17],["2014-09-22T17:00+00:00",6],["2014-09-23T02:00+00:00",1],["2014-09-23T04:00+00:00",1],["2014-09-23T06:00+00:00",13],["2014-09-23T07:00+00:00",12],["2014-09-23T08:00+00:00",19],["2014-09-23T09:00+00:00",26],["2014-09-23T10:00+00:00",18],["2014-09-23T11:00+00:00",18],["2014-09-23T12:00+00:00",27],["2014-09-23T13:00+00:00",20],["2014-09-23T14:00+00:00",21],["2014-09-23T15:00+00:00",24],["2014-09-23T16:00+00:00",19],["2014-09-23T17:00+00:00",10],["2014-09-24T06:00+00:00",12],["2014-09-24T07:00+00:00",20],["2014-09-24T08:00+00:00",25],["2014-09-24T09:00+00:00",27],["2014-09-24T10:00+00:00",17],["2014-09-24T11:00+00:00",22],["2014-09-24T12:00+00:00",26],["2014-09-24T13:00+00:00",26],["2014-09-24T14:00+00:00",28],["2014-09-24T15:00+00:00",30],["2014-09-24T16:00+00:00",20],["2014-09-24T17:00+00:00",6],["2014-09-24T20:00+00:00",1],["2014-09-25T06:00+00:00",12],["2014-09-25T07:00+00:00",25],["2014-09-25T08:00+00:00",34],["2014-09-25T09:00+00:00",33],["2014-09-25T10:00+00:00",21],["2014-09-25T11:00+00:00",24],["2014-09-25T12:00+00:00",23],["2014-09-25T13:00+00:00",38],["2014-09-25T14:00+00:00",29],["2014-09-25T15:00+00:00",33],["2014-09-25T16:00+00:00",27],["2014-09-25T17:00+00:00",12],["2014-09-26T04:00+00:00",1],["2014-09-26T06:00+00:00",36],["2014-09-26T07:00+00:00",44],["2014-09-26T08:00+00:00",59],["2014-09-26T09:00+00:00",52],["2014-09-26T10:00+00:00",50],["2014-09-26T11:00+00:00",51],["2014-09-26T12:00+00:00",45],["2014-09-26T13:00+00:00",45],["2014-09-26T14:00+00:00",52],["2014-09-26T15:00+00:00",58],["2014-09-26T16:00+00:00",48],["2014-09-26T17:00+00:00",19],["2014-09-26T21:00+00:00",1],["2014-09-27T01:00+00:00",1],["2014-09-27T06:00+00:00",42],["2014-09-27T07:00+00:00",58],["2014-09-27T08:00+00:00",74],["2014-09-27T09:00+00:00",63],["2014-09-27T10:00+00:00",63],["2014-09-27T11:00+00:00",56],["2014-09-27T12:00+00:00",66],["2014-09-27T13:00+00:00",57],["2014-09-27T14:00+00:00",57],["2014-09-27T15:00+00:00",55],["2014-09-27T16:00+00:00",43],["2014-09-27T17:00+00:00",26],["2014-09-27T18:00+00:00",1],["2014-09-27T19:00+00:00",1],["2014-09-27T21:00+00:00",1],["2014-09-29T01:00+00:00",1],["2014-09-29T04:00+00:00",3],["2014-09-29T05:00+00:00",1],["2014-09-29T06:00+00:00",12],["2014-09-29T07:00+00:00",29],["2014-09-29T08:00+00:00",43],["2014-09-29T09:00+00:00",47],["2014-09-29T10:00+00:00",36],["2014-09-29T11:00+00:00",24],["2014-09-29T12:00+00:00",33],["2014-09-29T13:00+00:00",37],["2014-09-29T14:00+00:00",33],["2014-09-29T15:00+00:00",30],["2014-09-29T16:00+00:00",19],["2014-09-29T17:00+00:00",3],["2014-09-29T19:00+00:00",1]]},"name":"test","$$hashKey":"object:956"};

				// converts a response JSON as returned by the backend to a JSON which we can plot with D3
				var convertResponse = function (response) {
					var dateIndex = undefined;
					var valueIndex = undefined;
					var currentIndex = 0;
					for (index = 0; index < response.columnHeaders.length; ++index) {
						if (response.columnHeaders[index].dataType == "DATE") {
							dateIndex = currentIndex;
						} else if (response.columnHeaders[index].dataType == "INTEGER") {
							valueIndex = currentIndex;
						}
						if (response.columnHeaders[index].columnType == "DIMENSION") {
							currentIndex++;
						}
					}
					if (dateIndex == undefined || valueIndex == undefined) {
						return [];
					}

					var values = [];
					for (index = 0; index < response.rows.length; ++index) {
						var row = response.rows[index];
						values.push({
							date: new Date(row[dateIndex]),
							value: row[valueIndex]
						});
					}

					return {
						name: response.view_id,
						values: values
					};
				}

				// converts an array of responses
				var convertAllResponses = function (responseArray) {
					var data = [];
					for (index = 0; index < responseArray.length; ++index) {
						var response = responseArray[index];
						if (response != undefined && response.columnHeaders != undefined && response.rows != undefined) {
							data.push(convertResponse(response));
						}
					}
					return data;
				}

				// CODE WILL DISPLAY WITHIN THE HTML ELEMENT d3bars
				// (currently at analysticsList.html)
				var svg = d3.select(ele[0])
					.append('svg')
					.attr("width", '100%')
					.attr("height", '100%');

				/*var margin = parseInt(attrs.margin) || 20,
					barHeight = parseInt(attrs.barHeight) || 20,
                    barPadding = parseInt(attrs.barPadding) || 5;*/


				// $scope.barRequest; <- this is the request object
				console.log(scope.barRequest);

				console.log(JSON.stringify(scope.barRequest));

				if (scope.barRequest !== null) {
					scope.data = convertAllResponses([scope.barRequest.data]);
				} else {
					scope.data = [];
				}

				// Browser onresize event
				window.onresize = function () {
					scope.$apply();
				};

				var response = {
					"start_date": "2014-09-01",
					"end_date": "2015-09-30",
					"view_id": "554cf46ecd19d7233900000f",
					"columnHeaders": [
						{
							"name": "count",
							"columnType": "METRIC"
                    },
						{
							"name": "longVisits",
							"columnType": "DIMENSION",
							"dataType": "INTEGER"
                    },
						{
							"name": "dateHour",
							"columnType": "DIMENSION",
							"dataType": "DATE"
                    }
                  ],
					"rows": [
                    [
                      1,
                      "2014-09-08T05:00+00:00"
                    ],
                    [
                      3,
                      "2014-09-19T07:00+00:00"
                    ],
                    [
                      4,
                      "2014-09-19T11:00+00:00"
                    ],
                    [
                      3,
                      "2014-09-25T07:00+00:00"
                    ],
                    [
                      10,
                      "2014-09-26T16:00+00:00"
                    ],
                    [
                      5,
                      "2014-09-27T13:00+00:00"
                    ],
                    [
                      5,
                      "2014-09-29T09:00+00:00"
                    ],
                    [
                      7,
                      "2014-10-04T05:00+00:00"
                    ],
                    [
                      2,
                      "2014-10-15T14:00+00:00"
                    ]
                  ]
				};
				//scope.data = convertAllResponses([response]);

				// Watch for resize event
				scope.$watch(function () {
					return angular.element($window)[0].innerWidth;
				}, function () {
					scope.render(scope.data);
				});

				scope.render = function (data) {
					// remove all previous items before render
					svg.selectAll('*').remove();

					console.log(JSON.stringify(data));
					if (data == undefined || data.length == undefined || data.length == 0) {
						return;
					}

					var margin = {
							top: 20,
							right: 80,
							bottom: 30,
							left: 70
						},
						width = d3.select(ele[0]).node().offsetWidth - margin.left - margin.right,
						height = 600 - margin.top - margin.bottom;

					var x = d3.time.scale()
						.range([0, width]);

					var y = d3.scale.linear()
						.range([height, 0]);

					var color = d3.scale.category10();

					var xAxis = d3.svg.axis()
						.scale(x)
						.orient("bottom");

					var yAxis = d3.svg.axis()
						.scale(y)
						.orient("left");

					var line = d3.svg.line()
						.interpolate("linear")
						.x(function (d) {
							return x(d.date);
						})
						.y(function (d) {
							return y(d.value);
						});

					color.domain(data.map(function (entry) {
						return entry.name;
					}));

					x.domain([
                        d3.min(data, function (d) {
							return d3.min(d.values, function (v) {
								return v.date;
							});
						}),
                        d3.max(data, function (d) {
							return d3.max(d.values, function (v) {
								return v.date;
							});
						})
                    ]);

					y.domain([
                        d3.min(data, function (d) {
							return d3.min(d.values, function (v) {
								return v.value;
							});
						}),
                        d3.max(data, function (d) {
							return d3.max(d.values, function (v) {
								return v.value;
							});
						})
                    ]);

					svg = svg.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

					svg.append("g")
						.attr("class", "x axis")
						.attr("transform", "translate(0," + height + ")")
						.call(xAxis);

					svg.append("g")
						.attr("class", "y axis")
						.call(yAxis)
						.append("text")
						.attr("transform", "rotate(-90)")
						.attr("y", 6)
						.attr("dy", ".71em")
						.style("text-anchor", "end")
						.text("Daily Visitors");

					var view = svg.selectAll(".view")
						.data(data)
						.enter().append("g")
						.attr("class", "view");

					view.append("path")
						.attr("class", "line")
						.attr("d", function (d) {
							return line(d.values);
						})
						.style("stroke", function (d) {
							return color(d.name);
						});

					view.append("text")
						.datum(function (d) {
							return {
								name: d.name,
								value: d.values[d.values.length - 1]
							};
						})
						.attr("transform", function (d) {
							return "translate(" + x(d.value.date) + "," + y(d.value.value) + ")";
						})
						.attr("x", 3)
						.attr("dy", ".35em")
						.text(function (d) {
							return d.name;
						});
				}
			});
		}
	};
}]);